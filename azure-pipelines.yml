trigger:
- main

stages:
# =====================
# STAGE 1 : TEST
# =====================
- stage: test
  displayName: "Tests Akaunting"
  jobs:
  - job: phpunit
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository ppa:ondrej/php -y
        sudo apt-get update

        # PHP + extensions n√©cessaires (ajuste si besoin)
        sudo apt-get install -y php8.2 php8.2-cli php8.2-mbstring php8.2-xml php8.2-curl php8.2-zip php8.2-bcmath php8.2-intl php8.2-sqlite3 unzip git sqlite3

        php -v

        # Composer
        curl -sS https://getcomposer.org/installer | php
        sudo mv composer.phar /usr/local/bin/composer
        composer --version

        # Install deps + env
        composer install --no-interaction --prefer-dist
        cp .env.example .env || true
        php artisan key:generate

        # SQLite in-memory / local file
        touch database/database.sqlite

        # Run tests
        php artisan test
      displayName: "Install PHP & Run tests"

# =====================
# STAGE 2 : BUILD
# =====================
- stage: build
  displayName: "Build Akaunting"
  dependsOn: test
  condition: succeeded()
  jobs:
  - job: build_app
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository ppa:ondrej/php -y
        sudo apt-get update

        sudo apt-get install -y php8.2 php8.2-cli php8.2-mbstring php8.2-xml php8.2-curl php8.2-zip php8.2-bcmath php8.2-intl unzip git
        php -v

        # Composer
        curl -sS https://getcomposer.org/installer | php
        sudo mv composer.phar /usr/local/bin/composer

        # Node
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
        sudo apt-get install -y nodejs
        node -v
        npm -v

        # Build
        composer install --no-dev --optimize-autoloader --no-interaction
        npm install
        npm run build
      displayName: "Install PHP & Node, then build"

    - publish: .
      artifact: akaunting-build

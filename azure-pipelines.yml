trigger:
  branches:
    include:
      - main

variables:
  # === ACR ===
  ACR_LOGIN_SERVER: 'myacr.azurecr.io'
  IMAGE_NAME: 'akaunting'
  TAG: '$(Build.BuildId)'

  # === Azure Web App ===
  AZURE_SUBSCRIPTION: 'My-Service-Connection-Name'   # service connection
  WEBAPP_NAME: 'my-akaunting-webapp'                 # Azure Web App name
  RESOURCE_GROUP: 'my-rg'

stages:
# =========================
# STAGE 1: TEST
# =========================
- stage: test
  displayName: "Test"
  jobs:
  - job: phpunit
    displayName: "PHPUnit + basic checks"
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    - task: DockerInstaller@0
      displayName: "Install Docker"
      inputs:
        dockerVersion: '24.0.9'

    - script: |
        docker build -t akaunting-test -f Dockerfile .
      displayName: "Build test image"

    - script: |
        docker run --rm \
          -e APP_ENV=testing \
          -e DB_CONNECTION=sqlite \
          -e DB_DATABASE=":memory:" \
          akaunting-test \
          bash -lc "php -v && composer -V && php artisan key:generate && php artisan test"
      displayName: "Run tests (sqlite memory)"

# =========================
# STAGE 2: BUILD
# =========================
- stage: build
  displayName: "Build & Push Docker Image"
  dependsOn: test
  condition: succeeded()
  jobs:
  - job: build_push
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    - task: Docker@2
      displayName: "Login to ACR"
      inputs:
        command: login
        containerRegistry: 'My-ACR-Service-Connection'  # ACR service connection

    - task: Docker@2
      displayName: "Build & Push"
      inputs:
        command: buildAndPush
        repository: '$(IMAGE_NAME)'
        dockerfile: 'Dockerfile'
        containerRegistry: 'My-ACR-Service-Connection'
        tags: |
          $(TAG)
          latest

# =========================
# STAGE 3: DEPLOY
# =========================
- stage: deploy
  displayName: "Deploy to Azure Web App (Container)"
  dependsOn: build
  condition: succeeded()
  jobs:
  - deployment: deploy_webapp
    displayName: "Deploy"
    environment: "production"
    pool:
      vmImage: ubuntu-latest
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebAppContainer@1
            displayName: "Deploy container to Web App"
            inputs:
              azureSubscription: '$(AZURE_SUBSCRIPTION)'
              appName: '$(WEBAPP_NAME)'
              containers: |
                $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(TAG)

trigger:
- main

pool:
  name: Default   # self-hosted agent (ILYAS)

variables:
  APP_ENV: testing
  DB_CONNECTION: sqlite
  DB_DATABASE: ":memory:"
  CACHE_DRIVER: array
  SESSION_DRIVER: array
  QUEUE_CONNECTION: sync

stages:
- stage: Test
  jobs:
  - job: PhpUnit
    displayName: "PHPUnit (Laravel)"
    steps:
    - checkout: self
      clean: true

    # Prepare .env early so composer scripts don't fail
    - powershell: |
        if (!(Test-Path ".env")) { Copy-Item ".env.example" ".env" }

        # Ensure sqlite file exists (safer than :memory: for some composer/artisan hooks)
        if (!(Test-Path "database")) { New-Item -ItemType Directory -Path "database" | Out-Null }
        if (!(Test-Path "database/database.sqlite")) { New-Item -ItemType File -Path "database/database.sqlite" | Out-Null }

        Add-Content .env "`nAPP_ENV=testing"
        Add-Content .env "`nDB_CONNECTION=sqlite"
        Add-Content .env "`nDB_DATABASE=database/database.sqlite"
        Add-Content .env "`nCACHE_DRIVER=array"
        Add-Content .env "`nSESSION_DRIVER=array"
        Add-Content .env "`nQUEUE_CONNECTION=sync"

        php artisan key:generate
        New-Item -ItemType Directory -Force -Path "storage/test-reports" | Out-Null
      displayName: "Prepare Laravel env (before composer)"

    - powershell: |
        set PHPRC=C:\xampp\php
        php -v
        composer --version
        composer install --no-interaction --prefer-dist
      displayName: "Composer install"

    - powershell: |
        php artisan migrate --force
      displayName: "Migrate"

    - powershell: |
        php vendor/bin/phpunit --log-junit storage/test-reports/junit.xml
      displayName: "Run PHPUnit"

    - task: PublishTestResults@2
      displayName: "Publish JUnit results"
      condition: always()
      inputs:
        testResultsFormat: "JUnit"
        testResultsFiles: "storage/test-reports/junit.xml"
        failTaskOnFailedTests: true

    - task: PublishBuildArtifacts@1
      displayName: "Publish test reports artifact"
      condition: always()
      inputs:
        PathtoPublish: "storage/test-reports"
        ArtifactName: "test-reports"

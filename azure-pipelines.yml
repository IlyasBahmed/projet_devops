trigger:
- main

pool:
  name: Default   # self-hosted agent (ILYAS)

variables:
  APP_ENV: local
  APP_DEBUG: true
  DB_CONNECTION: sqlite
  DB_DATABASE: database/database.sqlite

steps:
- checkout: self
  clean: true

# ---------- PHP ----------
- powershell: |
    php -v
  displayName: "Check PHP"

# ---------- Composer ----------
- powershell: |
    composer --version
    composer install --no-interaction --prefer-dist
  displayName: "Composer install"

# ---------- Node / NPM ----------
- powershell: |
    node -v
    npm -v
    npm install
    npm run build || npm run dev
  displayName: "NPM install & build"

# ---------- Prepare Laravel env (SQLite for CI) ----------
- powershell: |
    if (!(Test-Path ".env")) {
      Copy-Item ".env.example" ".env"
    }

    if (!(Test-Path "database")) {
      New-Item -ItemType Directory -Path "database"
    }
    if (!(Test-Path "database/database.sqlite")) {
      New-Item -ItemType File -Path "database/database.sqlite"
    }

    php artisan key:generate
    php artisan config:clear
  displayName: "Prepare .env & SQLite"

# ---------- Migrations ----------
- powershell: |
    php artisan migrate --force
  displayName: "Run migrations"

# ---------- Tests (إذا كاينين) ----------
- powershell: |
    if (Test-Path "artisan") {
      php artisan test
    }
  displayName: "Run tests"

trigger:
- main

pool:
  name: Default   # self-hosted agent ILYAS

variables:
  APP_ENV: local
  APP_DEBUG: true
  DB_CONNECTION: sqlite
  DB_DATABASE: database/database.sqlite

stages:

# ======================
# STAGE 1: BUILD
# ======================
- stage: Build
  displayName: "Build Akaunting"
  jobs:
  - job: BuildJob
    displayName: "Install dependencies & build assets"
    steps:
    - checkout: self
      clean: true

    - powershell: |
        php -v
      displayName: "Check PHP"

    - powershell: |
        set PHPRC=C:\xampp\php
        composer install --no-interaction --prefer-dist
      displayName: "Composer install"

    - powershell: |
        node -v
        npm -v
        npm install
        npm run build || npm run dev
      displayName: "NPM install & build"

# ======================
# STAGE 2: TEST
# ======================
- stage: Test
  displayName: "Test Akaunting"
  dependsOn: Build
  jobs:
  - job: TestJob
    displayName: "Prepare env, migrate & test"
    steps:
    - powershell: |
        if (!(Test-Path ".env")) {
          Copy-Item ".env.example" ".env"
        }

        if (!(Test-Path "database")) {
          New-Item -ItemType Directory -Path "database"
        }

        if (!(Test-Path "database/database.sqlite")) {
          New-Item -ItemType File -Path "database/database.sqlite"
        }

        php artisan key:generate
        php artisan config:clear
      displayName: "Prepare .env & SQLite"

    - powershell: |
        php artisan migrate --force
      displayName: "Run migrations"

    - powershell: |
        php artisan test
      displayName: "Run tests"

# ======================
# STAGE 3: DEPLOY (اختياري)
# ======================
- stage: Deploy
  displayName: "Deploy (placeholder)"
  dependsOn: Test
  condition: succeeded()
  jobs:
  - job: DeployJob
    displayName: "Deploy Akaunting"
    steps:
    - powershell: |
        Write-Host "Deploy stage ready (Azure App Service / VM / Docker)"
      displayName: "Deploy step"
